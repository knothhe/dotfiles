#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ -f "$SCRIPT_DIR/common_functions.sh" ]; then
    source "$SCRIPT_DIR/common_functions.sh"
fi

DEFAULT_SOURCE_DIR="~/Workspace/Secrets/source"
DEFAULT_ENCRYPT_DIR="~/Workspace/Secrets/encrypt"
DEFAULT_DECRYPT_DIR="~/Workspace/Secrets/decrypt"
GPG_EMAIL="{{ .email }}"

usage() {
    cat << EOF
Usage: $(basename "$0") <command> [options]

Commands:
    encrypt    Encrypt files/directories
    decrypt    Decrypt files/directories

Encrypt Options:
    -s, --source     Source directory (default: $DEFAULT_SOURCE_DIR)
    -o, --output    Output directory (default: $DEFAULT_ENCRYPT_DIR)
    -f, --file      Specific file to encrypt (optional)
    -r, --remove    Remove original files after encryption (default: false)

Decrypt Options:
    -s, --source    Source directory (default: $DEFAULT_ENCRYPT_DIR)
    -o, --output   Output directory (default: $DEFAULT_DECRYPT_DIR)
    -f, --file     Specific file to decrypt (optional)
    -r, --remove   Remove encrypted files after decryption (default: false)

Examples:
    $(basename "$0") encrypt                           # Encrypt all files from default source
    $(basename "$0") encrypt -s ~/my/files             # Encrypt from custom source
    $(basename "$0") encrypt -f secret.txt             # Encrypt specific file
    $(basename "$0") decrypt                           # Decrypt all files from default source
    $(basename "$0") decrypt -s ~/encrypted -o ~/out    # Custom source and output

EOF
    exit 1
}

expand_path() {
    echo "$1" | sed "s|^~|$HOME|"
}

ensure_directory() {
    local dir="$1"
    local expanded_dir
    expanded_dir=$(expand_path "$dir")

    if [ ! -d "$expanded_dir" ]; then
        mkdir -p "$expanded_dir"
    fi
    echo "$expanded_dir"
}

validate_directory() {
    local dir="$1"
    local expanded_dir
    expanded_dir=$(expand_path "$dir")

    if [ ! -d "$expanded_dir" ]; then
        print_error "Directory does not exist: $expanded_dir"
        return 1
    fi
    echo "$expanded_dir"
}

validate_file() {
    local file="$1"
    local expanded_file
    expanded_file=$(expand_path "$file")

    if [ ! -f "$expanded_file" ]; then
        print_error "File does not exist: $expanded_file"
        return 1
    fi
    echo "$expanded_file"
}

check_gpg() {
    if ! command -v gpg >/dev/null 2>&1; then
        print_error "GPG is not installed"
        return 1
    fi
}

encrypt_file() {
    local input_file="$1"
    local source_dir="$2"
    local output_dir="$3"
    local remove_original="${4:-false}"

    local expanded_input
    expanded_input=$(expand_path "$input_file")
    local expanded_output
    expanded_output=$(expand_path "$output_dir")

    local relative_path
    relative_path="${expanded_input#$source_dir/}"
    local filename
    filename=$(basename "$relative_path")
    local dir_path
    dir_path=$(dirname "$relative_path")
    local output_file_dir="$expanded_output/$dir_path"

    print_progress "Encrypting: $relative_path"

    if [ "$dir_path" != "." ] && [ ! -d "$output_file_dir" ]; then
        mkdir -p "$output_file_dir"
    fi

    local output_file="$output_file_dir/${filename}.asc"

    if gpg --quiet --batch --yes --recipient "$GPG_EMAIL" --armor --encrypt --output "$output_file" "$expanded_input" 2>/dev/null; then
        print_success "Encrypted: $relative_path -> ${relative_path}.asc"

        if [ "$remove_original" = "true" ]; then
            rm -f "$expanded_input"
            print_info "Removed original" "$relative_path"
        fi
    else
        print_error "Failed to encrypt: $relative_path"
        return 1
    fi
}

decrypt_file() {
    local input_file="$1"
    local source_dir="$2"
    local output_dir="$3"
    local remove_original="${4:-false}"

    local expanded_input
    expanded_input=$(expand_path "$input_file")
    local expanded_output
    expanded_output=$(expand_path "$output_dir")

    local relative_path
    relative_path="${expanded_input#$source_dir/}"
    local filename
    filename=$(basename "$relative_path")
    local dir_path
    dir_path=$(dirname "$relative_path")
    local output_file_dir="$expanded_output/$dir_path"

    print_progress "Decrypting: $relative_path"

    if [ "$dir_path" != "." ] && [ ! -d "$output_file_dir" ]; then
        mkdir -p "$output_file_dir"
    fi

    local output_file
    output_file="$output_file_dir/${filename%.asc}"

    if gpg --quiet --batch --yes --decrypt --output "$output_file" "$expanded_input" 2>/dev/null; then
        print_success "Decrypted: $relative_path -> $relative_path"

        if [ "$remove_original" = "true" ]; then
            rm -f "$expanded_input"
            print_info "Removed original" "$relative_path"
        fi
    else
        print_error "Failed to decrypt: $relative_path"
        return 1
    fi
}

cmd_encrypt() {
    local source_dir="$DEFAULT_SOURCE_DIR"
    local output_dir="$DEFAULT_ENCRYPT_DIR"
    local specific_file=""
    local remove_original="false"
    local count=0

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--source)
                if [ -n "$specific_file" ]; then
                    print_error "Cannot use both -s/--source and -f/--file options"
                    usage
                fi
                source_dir="$2"
                shift 2
                ;;
            -o|--output)
                output_dir="$2"
                shift 2
                ;;
            -f|--file)
                if [ -n "$source_dir" ] && [ "$source_dir" != "$DEFAULT_SOURCE_DIR" ]; then
                    print_error "Cannot use both -f/--file and -s/--source options"
                    usage
                fi
                specific_file="$2"
                shift 2
                ;;
            -r|--remove)
                remove_original="true"
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                usage
                ;;
        esac
    done

    check_gpg || exit 1

    print_title "GPG Encryption"
    print_info "Source" "$source_dir"
    print_info "Output" "$output_dir"
    print_info "Recipient" "$GPG_EMAIL"
    echo

    if [ -n "$specific_file" ]; then
        local expanded_file
        expanded_file=$(validate_file "$specific_file") || exit 1
        local expanded_output
        expanded_output=$(ensure_directory "$output_dir")
        encrypt_file "$expanded_file" "$expanded_source" "$expanded_output" "$remove_original"
        return $?
    fi

    local expanded_source
    expanded_source=$(validate_directory "$source_dir") || exit 1
    local expanded_output
    expanded_output=$(ensure_directory "$output_dir")
    while IFS= read -r -d '' file; do
        encrypt_file "$file" "$expanded_source" "$expanded_output" "$remove_original"
        ((count++)) || true
    done < <(find "$expanded_source" -type f -print0 2>/dev/null)

    if [ "$count" -eq 0 ]; then
        print_warning "No files found in $source_dir"
    else
        print_info "Total files encrypted" "$count"
    fi

}

cmd_decrypt() {
    local source_dir="$DEFAULT_ENCRYPT_DIR"
    local output_dir="$DEFAULT_DECRYPT_DIR"
    local specific_file=""
    local remove_original="false"
    local count=0

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--source)
                if [ -n "$specific_file" ]; then
                    print_error "Cannot use both -s/--source and -f/--file options"
                    usage
                fi
                source_dir="$2"
                shift 2
                ;;
            -o|--output)
                output_dir="$2"
                shift 2
                ;;
            -f|--file)
                if [ -n "$source_dir" ] && [ "$source_dir" != "$DEFAULT_ENCRYPT_DIR" ]; then
                    print_error "Cannot use both -f/--file and -s/--source options"
                    usage
                fi
                specific_file="$2"
                shift 2
                ;;
            -r|--remove)
                remove_original="true"
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                usage
                ;;
        esac
    done

    check_gpg || exit 1

    print_title "GPG Decryption"
    print_info "Source" "$source_dir"
    print_info "Output" "$output_dir"
    echo

    if [ -n "$specific_file" ]; then
        local expanded_file
        expanded_file=$(validate_file "$specific_file") || exit 1
        local expanded_output
        expanded_output=$(ensure_directory "$output_dir")
        decrypt_file "$expanded_file" "$expanded_source" "$expanded_output" "$remove_original"
        return $?
    fi

    local expanded_source
    expanded_source=$(validate_directory "$source_dir") || exit 1
    local expanded_output
    expanded_output=$(ensure_directory "$output_dir")
    while IFS= read -r -d '' file; do
        decrypt_file "$file" "$expanded_source" "$expanded_output" "$remove_original"
        ((count++)) || true
    done < <(find "$expanded_source" -type f -name "*.asc" -print0 2>/dev/null)

    if [ "$count" -eq 0 ]; then
        print_warning "No .asc files found in $source_dir"
    else
        print_info "Total files decrypted" "$count"
    fi

}

main() {
    if [ $# -lt 1 ]; then
        usage
    fi

    local command="$1"
    shift

    case "$command" in
        encrypt)
            cmd_encrypt "$@"
            ;;
        decrypt)
            cmd_decrypt "$@"
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            print_error "Unknown command: $command"
            usage
            ;;
    esac
}

main "$@"
